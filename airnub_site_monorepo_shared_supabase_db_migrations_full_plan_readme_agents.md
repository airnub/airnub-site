# Airnub‑Site Monorepo — Shared Supabase DB & Migrations

**Monorepo name (private):** `airnub-site`

> A single PNPM monorepo for **all public-facing sites** using **one Supabase project** (shared database, one set of migrations & types). Contains:
> - **apps/airnub** → corporate site at `airnub.io`
> - **apps/speckit** → product microsite at `speckit.airnub.io`
> - **packages/ui**, **packages/brand**, **packages/seo** → shared UI + SEO helpers
> - **packages/db** → **shared Supabase client, generated types, SQL helpers**
> - **supabase/** → **single source of truth** for migrations, seed scripts, config
>
> Central Trust Center at `trust.airnub.io`; Docs at `docs.speckit.dev`.

---

## 0) Key decisions
- **One Supabase project** for all website apps. Benefits: one schema, one migration history, consistent RLS, fewer secrets to manage.
- **Shared DB package** (`packages/db`) exposes a typed Supabase client + DB types for all apps.
- **Migrations live at repo root** in `supabase/migrations/` using the Supabase CLI; CI runs them with approvals for staging/prod.
- **Namespaces**: keep most tables in `public` for simplicity; if needed, create logical schemas (`airnub`, `speckit`) later without changing the location of migration files.
- **Multi‑env**: dev/staging/prod handled via Supabase CLI `link` to different project refs and environment‑scoped secrets in CI.

---

## 1) Repository layout

```
airnub-site/
├─ apps/
│  ├─ airnub/                  # Company site (airnub.io)
│  │  ├─ app/
│  │  ├─ components/
│  │  ├─ lib/
│  │  ├─ public/
│  │  └─ package.json
│  └─ speckit/                 # Product microsite (speckit.airnub.io)
│     ├─ app/
│     ├─ components/
│     ├─ lib/
│     ├─ public/
│     └─ package.json
├─ packages/
│  ├─ ui/                      # Shared Tailwind components, tokens, icons
│  ├─ brand/                   # Logos, wordmarks, OG templates
│  ├─ seo/                     # JSON‑LD builders, OG helpers
│  └─ db/                      # ✅ Shared Supabase client, types, SQL helpers
│     ├─ src/
│     │  ├─ client.ts          # createBrowserClient/createServerClient helpers
│     │  ├─ types.ts           # generated by supabase CLI
│     │  ├─ queries/           # optional typed queries
│     │  └─ index.ts
│     └─ package.json
├─ supabase/                   # ✅ Single source of truth for DB
│  ├─ config.toml
│  ├─ migrations/              # timestamped SQL files
│  ├─ seed.sql                 # optional demo data (dev only)
│  └─ .gitignore
├─ .github/workflows/
│  ├─ ci.yml                   # lint/typecheck/build
│  ├─ a11y.yml                 # pa11y‑ci on key routes
│  ├─ links.yml                # broken link checker
│  └─ db-migrate.yml           # ✅ gated migrations for staging/prod
├─ turbo.json                  # optional Turborepo
├─ pnpm-workspace.yaml
├─ package.json
├─ README.md                   # (root) — this plan collapsed for contributors
└─ AGENTS.md                   # roles, milestones, acceptance
```

**Workspaces** (`pnpm-workspace.yaml`)
```yaml
packages:
  - "apps/*"
  - "packages/*"
```

**Root `package.json` (scripts)**
```json
{
  "name": "airnub-site",
  "private": true,
  "packageManager": "pnpm@9",
  "scripts": {
    "dev": "pnpm -r --parallel --filter ./apps/* dev",
    "build": "pnpm -r --filter ./apps/* build",
    "lint": "pnpm -r lint",
    "typecheck": "pnpm -r typecheck",
    "a11y": "pnpm --filter ./apps/* run a11y",
    "links": "pnpm --filter ./apps/* run links",
    "db:types": "supabase gen types typescript --local --schema public > packages/db/src/types.ts",
    "db:link:staging": "supabase link --project-ref $SUPABASE_STAGING_REF",
    "db:link:prod": "supabase link --project-ref $SUPABASE_PROD_REF",
    "db:push": "supabase db push",
    "db:diff": "supabase db diff --use-mig-dir supabase/migrations",
    "db:reset:local": "supabase stop || true && supabase start && supabase db reset"
  }
}
```

> Use `supabase start` for local dev; `db:diff` to create a new migration after editing the local DB; `db:push` to apply migrations to the linked remote env.

---

## 2) Domains & DNS (unchanged)
```
airnub.io                → hosting for apps/airnub
www.airnub.io            → airnub.io (or apex→www 301)
speckit.airnub.io        → hosting for apps/speckit
docs.speckit.dev         → <user>.github.io (CNAME in docs repo)
trust.airnub.io          → Trust Center host
```

---

## 3) Shared Supabase database — schema, RLS, migrations

### 3.1 Core tables (initial)
**`public.contact_leads`** (shared across apps; source column identifies origin)
```sql
create table if not exists public.contact_leads (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz not null default now(),
  full_name text,
  email text not null check (position('@' in email) > 1),
  company text,
  message text,
  source text check (source in ('airnub','speckit')) default 'airnub',
  consent boolean default false,
  user_agent text,
  ip_hash text
);

create index if not exists idx_contact_leads_created_at
  on public.contact_leads (created_at desc);
```

**RLS policies** (marketing forms: allow **insert** from anon; restrict **select** to service role)
```sql
-- Enable RLS
a lter table public.contact_leads enable row level security;

-- Inserts allowed to anyone (public website forms)
create policy "leads_insert_anon"
  on public.contact_leads
  for insert
  to anon
  with check (true);

-- Select only allowed to authenticated service role (server) or admin
create policy "leads_read_service"
  on public.contact_leads
  for select
  to service_role
  using (true);

-- Updates/deletes: default deny (add policies later if needed)
```

> If you prefer stricter insert validation, swap anon inserts for a server action/Edge Function using the service role, then drop the `anon` insert policy.

### 3.2 Optional product namespaces
If you foresee many product‑specific tables, you can **prefix** table names (`speckit_*`) *or* create additional schemas:
```sql
create schema if not exists speckit;
-- example per-product table
create table if not exists speckit.site_events (
  id bigserial primary key,
  created_at timestamptz not null default now(),
  event text not null,
  payload jsonb
);
```
Migrations still live in `supabase/migrations/` regardless of schema.

### 3.3 Migrations workflow (single source of truth)
- Local: `supabase start` → modify schema via SQL (or SQL editor) → `pnpm db:diff -m "meaningful_name"` → PR.
- Staging: when PR merges to `main`, CI runs `supabase link --project-ref $SUPABASE_STAGING_REF` then `supabase db push`.
- Production: gated job (manual approval) runs `supabase link --project-ref $SUPABASE_PROD_REF` then `supabase db push`.

**Example migration file name**
```
supabase/migrations/20250926T101500_add_contact_leads.sql
```

### 3.4 Types generation (shared to all apps)
Generate types from **local** or **linked remote** to `packages/db/src/types.ts`:
```bash
pnpm db:types
# Or remote:
SUPABASE_DB_URL=... supabase gen types typescript --db-url "$SUPABASE_DB_URL" > packages/db/src/types.ts
```
Apps import types from `@airnub/db`.

---

## 4) `packages/db` — shared client & helpers

**`packages/db/package.json`**
```json
{
  "name": "@airnub/db",
  "version": "0.1.0",
  "main": "src/index.ts",
  "type": "module",
  "dependencies": {
    "@supabase/supabase-js": "^2.45.0"
  }
}
```

**`packages/db/src/client.ts`**
```ts
import { createBrowserClient, createServerClient } from "@supabase/supabase-js";
import type { Database } from "./types";

export function getBrowserClient(opts?: { url?: string; anonKey?: string }) {
  const url = opts?.url || process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const anon = opts?.anonKey || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
  return createBrowserClient<Database>(url, anon);
}

export function getServerClient(cookies: () => any, opts?: { url?: string; anonKey?: string }) {
  const url = opts?.url || process.env.NEXT_PUBLIC_SUPABASE_URL!;
  const anon = opts?.anonKey || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
  return createServerClient<Database>(url, anon, { cookies });
}
```

**`packages/db/src/index.ts`**
```ts
export * from "./client";
export type { Database } from "./types";
```

> Each app adds its own `.env.local` with the **same** Supabase URL/Anon key (or different per‑env). No secrets in the shared package.

---

## 5) Apps consume the shared DB

**`apps/airnub/lib/supabase.ts`**
```ts
import { getBrowserClient } from "@airnub/db";
export const supabase = getBrowserClient();
```

**Insert lead (server action) — example**
```ts
"use server";
import { cookies } from "next/headers";
import { getServerClient } from "@airnub/db";

export async function submitLead(input: { full_name?: string; email: string; company?: string; message?: string }) {
  const db = getServerClient(cookies);
  const { error } = await db.from("contact_leads").insert({ ...input, source: "airnub", consent: false });
  if (error) throw new Error(error.message);
}
```

**`apps/speckit`** does the same but sets `source: "speckit"`.

---

## 6) Information Architecture (apps)

### apps/airnub
- `/` Home · `/products` · `/solutions` · `/services` · `/resources` · `/company` · `/contact` · `/trust` (redirect)

### apps/speckit
- `/` Home · `/product` · `/how-it-works` · `/solutions/ciso` · `/solutions/devsecops` · `/template` · `/pricing` · `/contact` · `/trust` (redirect)

Both apps: Next.js Metadata API per page, `sitemap.ts`, `robots.ts`, dynamic OG images, JSON‑LD (`Organization` + `ItemList` on Airnub; `SoftwareApplication` on Speckit), WCAG 2.2 AA, and CWV budgets.

---

## 7) CI/CD — including DB migrations

**`.github/workflows/db-migrate.yml` (sketch)**
```yaml
name: db-migrate
on:
  push:
    branches: [main]
    paths:
      - "supabase/migrations/**"
  workflow_dispatch:

jobs:
  migrate-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - run: pnpm i -w
      - name: Link staging project
        run: supabase link --project-ref ${{ secrets.SUPABASE_STAGING_REF }}
      - name: Push migrations (staging)
        run: supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}

  migrate-prod:
    needs: migrate-staging
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - run: pnpm i -w
      - name: Link prod project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROD_REF }}
      - name: Push migrations (prod)
        run: supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
```

> Keep DB credentials in **environment‑scoped GitHub Secrets**. Consider a manual approval gate for production.

**App CI** stays as before (lint/typecheck/build, a11y, links). Add a job to regenerate types and ensure `packages/db/src/types.ts` stays in sync (or skip committing types and generate on build).

---

## 8) Security & privacy
- `contact_leads` is **write‑only** from the public; restrict reads to service role/admin; process export on backend only.
- If capturing IP, **hash** it (salted) or avoid storing; honor consent for contact/marketing.
- Place **security.txt** and VDP on `trust.airnub.io`; link from both apps.

---

## 9) README.md (root)

```markdown
# Airnub‑Site Monorepo

Monorepo for public‑facing sites using **one shared Supabase database** and a **single migrations directory**.

## Apps
- **Airnub company site** — https://airnub.io (apps/airnub)
- **Speckit microsite** — https://speckit.airnub.io (apps/speckit)

## Packages
- **@airnub/ui** — shared UI
- **@airnub/brand** — assets
- **@airnub/seo** — JSON‑LD & OG helpers
- **@airnub/db** — shared Supabase client + types

## Supabase
- Migrations live in `/supabase/migrations/` (single source of truth)
- Local dev: `supabase start` → edit schema → `pnpm db:diff -m "change"`
- Types: `pnpm db:types` → writes to `packages/db/src/types.ts`
- Remote apply: `pnpm db:link:staging && pnpm db:push` (CI handles staging/prod)

## Getting started
```bash
pnpm i
pnpm dev
# or: pnpm --filter ./apps/airnub dev
#     pnpm --filter ./apps/speckit dev
```

## Environment
Create `.env.local` in each app with the **same** Supabase project keys:
```env
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
```
(Use different keys per environment.)

## CI
- App CI: lint, typecheck, build; pa11y‑ci; link checker
- DB CI: `db-migrate.yml` pushes migrations to staging on merge; prod requires approval

## Trust
- Trust Center: https://trust.airnub.io (VDP + `/.well-known/security.txt`)
```

---

## 10) AGENTS.md (monorepo with shared DB)

```markdown
# AGENTS.md — Airnub‑Site Monorepo (Shared DB)

## Roles
- **Monorepo Lead Agent** — workspaces, shared packages, CI.
- **DB/Migrations Agent** — owns schema, RLS, migrations, types.
- **Airnub App Agent** — builds apps/airnub pages and integrates @airnub/db.
- **Speckit App Agent** — builds apps/speckit pages and integrates @airnub/db.
- **Content Agent** — copy for Home/Products/Solutions/Services and Speckit pages.
- **Trust Agent** — Trust Center links, VDP/security.txt coordination.
- **QA Agent** — a11y, links, metadata, CWV smoke, DB CI checks.

## Guardrails
1. **DB**: All schema changes via migration files under `supabase/migrations/`. No direct prod edits.
2. **RLS**: Public tables allow only the minimum required (insert‑only for forms). Reads restricted to service role.
3. **Types**: Regenerate after schema changes; apps must compile against `@airnub/db` types.
4. **Apps**: Every route defines `generateMetadata`; sitemaps, robots, JSON‑LD present; headers/footers link to GitHub + Trust.
5. **A11y/CWV**: WCAG 2.2 AA; LCP ≤ 2.5s, INP < 200ms, CLS < 0.1.

## Milestone 1 — Monorepo & packages
- Init PNPM workspaces; scaffold apps + packages.
- Add `packages/db` with client + placeholder `types.ts`.
- Add `supabase/config.toml`.
**Acceptance**: `pnpm i && pnpm build` passes for both apps.

## Milestone 2 — Supabase local & base schema
- `supabase start`; create `contact_leads` + RLS policies; `pnpm db:diff -m "create_contact_leads"`.
- `pnpm db:types` to generate types.
**Acceptance**: Migration file created; types compile in both apps.

## Milestone 3 — Pages & forms
- Build required pages in both apps; implement `submitLead` server actions using `@airnub/db`.
**Acceptance**: Lead inserts succeed from both apps; `source` is correct.

## Milestone 4 — CI (apps + DB)
- Add app CI; add `db-migrate.yml` for staging on merge; prod gated.
**Acceptance**: CI green; staging migrations apply automatically on merge.

## Milestone 5 — Launch
- Configure DNS; deploy both apps; verify Search Console; submit sitemaps.
**Acceptance**: Sites live; Trust links resolve; basic CWV telemetry enabled.
```

---

## 11) Launch checklist
- [ ] `airnub-site` created with PNPM workspaces
- [ ] `packages/db` added; types generated
- [ ] `supabase/migrations` contains base schema + policies
- [ ] Apps consume `@airnub/db` and share the same env keys
- [ ] App pages built with metadata, sitemaps, robots, JSON‑LD, OG
- [ ] CI: app workflows + `db-migrate.yml` configured
- [ ] DNS set for `airnub.io`, `speckit.airnub.io`; Trust Center reachable; docs CNAME
- [ ] Search Console properties verified; sitemaps submitted

---

## 12) Notes
- If you later split into multiple Supabase **projects** (per product), you can **keep the same structure**: move DB package to multi‑project awareness (env‑based switching) and split migrations by folder (e.g., `supabase/airnub/*`, `supabase/speckit/*`). Start simple with **one project**.
- Consider an email notification path (Edge Function or third‑party) for new leads.
- Add legal pages (Privacy, Terms) when ready; include company details in footers.

